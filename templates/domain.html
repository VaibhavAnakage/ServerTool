<!DOCTYPE html>
<html>
<head>
    <title>Domain Monitoring</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <header>
        <div class="container">
            <h1>Domain Monitoring Dashboard</h1>
        </div>
    </header>

    <nav>
        <div class="container">
            <ul>
                <li><a href="/">Dashboard</a></li>
                <li><a href="/domain">Domain Monitoring</a></li>
                <li><a href="/server">Server Info</a></li>
                {% if user and (user.role or '').lower() == 'super_admin' %}
                    <li><a href="/users">Users</a></li>
                {% endif %}
                {% if user %}
                    <li style="margin-left:auto"><a href="/logout">Logout ({{ user.name }})</a></li>
                {% else %}
                    <li style="margin-left:auto"><a href="/login">Login</a></li>
                {% endif %}
            </ul>
        </div>
    </nav>

    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }}">
                <strong>{{ category.title() }}:</strong> {{ message }}
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <div class="card">
            <h2>Add New Domain</h2>
            <form method="POST" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <input type="text" name="domain_name" placeholder="example.com" required class="form-control" style="flex: 1; min-width: 200px;">
                <select name="location" class="form-control" style="min-width: 180px;">
                    {% for loc in locations %}
                        <option value="{{ loc }}">{{ loc }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-primary">Add Domain</button>
            </form>
        </div>

        {% if domains %}
            <div class="card">
                <h2>Monitored Domains</h2>
                <div class="table-container">
                    <table class="domains-table">
                        <thead>
                            <tr>
                                <th>Domain</th>
                                <th>SSL Issuer</th>
                                <th>SSL Expiry</th>
                                <th>Days to Expiry</th>
                                <th>Location</th>
                                <th>Security</th>
                                <th>Alert Configuration</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for d in domains %}
                            <tr>
                                <td><strong>{{ d.name }}</strong></td>
                                <td>{{ d.ssl_issuer or '-' }}</td>
                                <td>{{ d.ssl_expiry or '-' }}</td>
                                <td>
                                    {% if d.days_left is not none %}
                                        {% if d.days_left < 0 %}
                                            <span class="badge badge-danger">Expired {{ -d.days_left }} day(s) ago</span>
                                        {% elif d.days_left <= 30 %}
                                            <span class="badge badge-warning">{{ d.days_left }} day(s)</span>
                                        {% else %}
                                            <span class="badge badge-success">{{ d.days_left }} day(s)</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge badge-info">Unknown</span>
                                    {% endif %}
                                </td>
                                <td>{{ d.location or '-' }}</td>
                                <td>
                                    <span class="badge sec-badge" data-domain="{{ d.name|e }}">Loading...</span>
                                    <div style="margin-top:6px; display:flex; gap:6px;">
                                        <a class="btn btn-sm btn-secondary" href="/domain/security/{{ d.name }}">View</a>
                                        <button class="btn btn-sm btn-primary btn-sec-scan" data-domain="{{ d.name|e }}">Scan Now</button>
                                    </div>
                                    <div class="sec-time" data-domain="{{ d.name|e }}" style="font-size: 0.85em; margin-top:4px; color:#555;"></div>
                                </td>
                                <td>
                                    {% if d.alert_recipients %}
                                        <div style="font-size: 0.9em;">
                                            <div><strong>Recipients:</strong> {{ d.alert_recipients }}</div>
                                            <div><strong>Days before:</strong> {{ d.alert_days_before }}</div>
                                            <div><strong>Frequency:</strong> {{ d.alert_frequency or 'once' }}</div>
                                            <div><strong>Send once:</strong> {{ 'Yes' if d.alert_send_once else 'No' }}</div>
                                            <div><strong>Active:</strong> {{ 'Yes' if d.alert_active else 'No' }}</div>
                                            {% if d.alert_end_date %}
                                                <div><strong>Ends:</strong> {{ d.alert_end_date }}</div>
                                            {% endif %}
                                            {% if d.alert_last_sent %}
                                                <div><strong>Last Sent:</strong> {{ d.alert_last_sent }}</div>
                                            {% endif %}
                                            <div><strong>Status:</strong> 
                                                <span class="badge {% if d.alert_sent %}badge-success{% else %}badge-warning{% endif %}">
                                                    {{ 'Sent' if d.alert_sent else 'Pending' }}
                                                </span>
                                            </div>
                                        </div>
                                    {% else %}
                                        <span class="badge badge-info">No alerts configured</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('alert') }}?domain_name={{ d.name }}" class="btn btn-sm btn-primary">
                                        {{ 'Edit Alert' if d.alert_recipients else 'Set Alert' }}
                                    </a>
                                    <a href="/domain/edit/{{ d.name }}" class="btn btn-sm btn-secondary" style="margin-left:6px;">Edit</a>
                                    <form action="/domain/delete/{{ d.name }}" method="POST" style="display:inline-block; margin-left:6px;" onsubmit="return confirm('Delete domain {{ d.name|e }}?');">
                                        <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% else %}
            <div class="card">
                <div class="alert alert-info">
                    <strong>No domains configured yet.</strong> Add your first domain above to start monitoring SSL certificates and expiration dates.
                </div>
            </div>
        {% endif %}

        <div class="card">
            <h2>Quick Actions</h2>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <a href="/server" class="btn btn-secondary">Server Info</a>
                <a href="/server/history" class="btn btn-secondary">Server History</a>
                <a href="/run_alerts" class="btn btn-success">Run Alerts Now</a>
            </div>
        </div>
    </div>

    

    <script>
    function statusBadge(summary){
        if(summary === 'secure') return '<span class="badge badge-success">Secure</span>';
        if(summary === 'at_risk') return '<span class="badge badge-warning">At Risk</span>';
        if(summary === 'critical') return '<span class="badge badge-danger">Critical Issues</span>';
        return '<span class="badge badge-info">Unknown</span>';
    }

    async function loadSecuritySummaries(){
        try{
            const res = await fetch('/api/domain-security/latest', {credentials:'same-origin'});
            if(!res.ok) return;
            const data = await res.json();
            (data.domains||[]).forEach(item => {
                const badge = document.querySelector('.sec-badge[data-domain="' + item.domain + '"]');
                const time = document.querySelector('.sec-time[data-domain="' + item.domain + '"]');
                if(badge){ badge.innerHTML = statusBadge(item.summary_status); }
                if(time){ time.textContent = item.scanned_at ? ('Last scan: ' + item.scanned_at) : ''; }
            });
        }catch(e){}
    }

    async function scanNow(domain){
        try{
            const badge = document.querySelector('.sec-badge[data-domain="' + domain + '"]');
            const time = document.querySelector('.sec-time[data-domain="' + domain + '"]');
            if(badge) badge.textContent = 'Scanning...';
            const res = await fetch('/api/domain-security/scan?domain=' + encodeURIComponent(domain), {method:'POST', credentials:'same-origin'});
            if(!res.ok) return;
            const data = await res.json();
            if(badge){ badge.innerHTML = statusBadge(data.summary_status); }
            if(time){ time.textContent = 'Last scan: ' + (data.scanned_at || ''); }
        }catch(e){}
    }

    // Delegate button clicks to avoid inline handlers
    document.addEventListener('click', function(ev){
        const scanBtn = ev.target.closest('.btn-sec-scan');
        if(scanBtn){
            const domain = scanBtn.getAttribute('data-domain');
            if(domain) scanNow(domain);
            return;
        }
    });

    // Initial load
    loadSecuritySummaries();
    </script>
</body>
</html>
